<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Clients Dashboard</title>
</head>
<body>
  <h1>Client Dashboard</h1>
  <div id="output"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const clientName = params.get('name');
    const pin = params.get('pin');
    const output = document.getElementById('output');

    if (!clientName || !pin) {
      output.innerHTML = '<p>Missing client name or PIN.</p>';
      return;
    }

    fetch('/clients')
      .then(res => res.json())
      .then(clients => {
        const client = clients.find(c =>
          c.name.toLowerCase() === clientName.toLowerCase()
        );

        if (!client || client.pin !== pin) {
          output.innerHTML = '<p>Invalid client name or PIN.</p>';
          return;
        }

        let html = `
          <h2>Welcome, ${client.name}</h2>
          <p>📧 ${client.contactEmail} | 📞 ${client.contactPhone}</p>
          <hr>
          <h3>Claims</h3><ul id="claims-list"></ul>
          <h3>Documents</h3><ul id="documents-list"></ul>
        `;
        output.innerHTML = html;

        fetch('/claims?client=' + encodeURIComponent(client.name))
          .then(res => res.json())
          .then(claims => {
            const claimsList = document.getElementById('claims-list');
            claims.forEach(claim => {
              const li = document.createElement('li');
              li.innerHTML = `
                📝 <strong>${claim.claimNumber}</strong><br>
                ${claim.description}<br>
                Stage: ${claim.stage}<br>
                Notes: ${claim.notes}<br>
                Submitted: ${new Date(claim.submittedAt).toLocaleDateString()}
              `;
              claimsList.appendChild(li);
            });
          });

        fetch('/documents?client=' + encodeURIComponent(client.name))
          .then(res => res.json())
          .then(documents => {
            const docsList = document.getElementById('documents-list');
            documents.forEach(doc => {
              const li = document.createElement('li');
              li.innerHTML = `
                📎 ${doc.originalName}<br>
                Uploaded: ${new Date(doc.date).toLocaleDateString()}<br>
                ${doc.claimNumber ? 'Linked to Claim #' + doc.claimNumber : ''}
              `;
              docsList.appendChild(li);
            });
          });
      });
  </script>
</body>
</html>
